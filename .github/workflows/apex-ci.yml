name: APEX CI

on:
  push:
    branches: [ main ]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Validate APEX export
        run: |
          echo "Checking APEX export..."

          if [ -f "apex/f17152.sql" ]; then
            echo "âŒ Single-file export detected."
            echo "Use APEX split export for CI/CD."
            exit 1
          fi

          if [ ! -d "apex/f17152" ]; then
            echo "âŒ Split export folder apex/f17152 missing."
            exit 1
          fi

          if [ ! -f "apex/f17152/application/create_application.sql" ]; then
            echo "âŒ application.sql missing."
            exit 1
          fi

          echo "âœ… APEX export structure is valid"

      - name: Package APEX artifact
        run: |
          cd apex
          zip -r apex-app-${{ github.sha }}.zip f17152

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: apex-app
          path: apex/apex-app-${{ github.sha }}.zip

# -------------------
# 2. CD job
# -------------------
  cd:
    runs-on: ubuntu-latest
    needs: ci   # â¬…ï¸ IMPORTANT

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install SQLcl
        run: |
          curl -L https://download.oracle.com/otn_software/java/sqldeveloper/sqlcl-latest.zip -o sqlcl.zip
          unzip sqlcl.zip
          echo "$PWD/sqlcl/bin" >> $GITHUB_PATH

      - name: Setup Oracle Wallet
        run: |
          mkdir wallet
          echo "${{ secrets.ADB_TNS_ADMIN }}" | base64 --decode > wallet.zip
          unzip wallet.zip -d wallet
          echo "TNS_ADMIN=$PWD/wallet" >> $GITHUB_ENV

      # ðŸ‘‰ ADD YOUR STEP HERE
      - name: Run DB scripts
        run: |
          sql "${{ secrets.ADB_USERNAME }}/${{ secrets.ADB_PASSWORD }}@${{ secrets.ADB_SERVICE }}" @db/V001_create_tables.sql
      - name: Deploy APEX app
        run: |
          sql ${{ secrets.ADB_USERNAME }}/${{ secrets.ADB_PASSWORD }}@${{ secrets.ADB_SERVICE }} <<EOF
          begin
           apex_application_install.set_workspace('WKSP_DEVWS');
           apex_application_install.set_schema('DEV_ADMIN');
           apex_application_install.set_application_id(100);
           apex_application_install.set_application_alias('TASK_TRACKER');
          end;
          /
          @apex/f100/application/create_application.sql
          EOF
