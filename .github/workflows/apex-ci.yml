name: APEX CI

on:
  push:
    branches: [ main ]

jobs:
  validate-apex:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Validate APEX export
        run: |
          echo "Checking APEX export..."

          if [ -f "apex/f17152.sql" ]; then
            echo "❌ Single-file export detected."
            echo "Use APEX split export for CI/CD."
            exit 1
          fi

          if [ ! -d "apex/f17152" ]; then
            echo "❌ Split export folder apex/f17152 missing."
            exit 1
          fi

          if [ ! -f "apex/f17152/application/create_application.sql" ]; then
            echo "❌ application.sql missing."
            exit 1
          fi

          echo "✅ APEX export structure is valid"

      - name: Package APEX artifact
        run: |
          cd apex
          zip -r apex-app-${{ github.sha }}.zip f17152

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: apex-app
          path: apex/apex-app-${{ github.sha }}.zip
